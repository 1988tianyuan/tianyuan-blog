title: 《深入理解计算机系统》读书笔记——Chapter 7(1)
author: 天渊
tags:
  - csapp
categories:
  - 读书笔记
date: 2019-10-28 23:24:00
---
本章主要介绍计算机系统中的异常处理流，当程序执行出错出现异常后，由硬件层，操作系统或者应用程序产生异常控制流对异常进行处理
<!--more-->

### 异常

计算机系统中使用`异常`（exception）的形式来实现异常控制流，比较简单的例子是，当CPU执行到某个指令后，执行状态发生变化，立即产生一个异常事件，这种事件有可能是内存缺页，甚至是某个指令试图除以0。产生事件后，CPU会通过`异常表`进行`异常过程调用`，由`Exception Handler`来专门处理这个异常事件

#### 异常表

系统中为每种类型的异常都分配了`异常号`，产生异常事件后，处理器执行异常过程调用时需要用这个异常号来从异常表中检索相应的`异常处理程序`，然后根据检索到的`异常处理程序`来执行相应的命令，跟一般的过程调用大同小异，不过还是有些区别：

- 异常过程调用的返回地址会根据异常的类型来判断，要么是返回当前正在执行的指令地址，要么是下一条指令的地址
- CPU会把一些额外的处理器状态压到栈里
- CPU在内核态中执行异常过程调用，会将上下文全部压到`内核栈`中
- 由于异常过程调用是运行在`内核态`下，因此这个过程对所有系统资源都有完全的访问权限

异常过程调用完成后，执行一条`从中断返回`的指令，将适当的状态弹回到处理器的控制和数据寄存器，如果中断的是用户态程序，则将上下文切换回用户态，控制返回给被中断的用户态应用程序

#### 四种异常类型

计算机系统将可能出现的异常分为四类：

- `中断`：对外部IO设备信号的响应，相对于正在执行的指令来说是异步发生的，由专门的`中断处理器(interrupt handler)`来处理这类中断信号

  中断类型跟其他三种异常还不太一样，中断不是由当前执行的指令产生的，IO设备通过向CPU的中断引脚发信号并将中断号发到总线上，CPU执行完当前指令后注意到中断引脚的电压变高，从系统总线读取中断号然后调用对应的中断处理器，调用完成后**返回到下一条指令**，就当这个中断从未发生过

- `陷阱`：这类异常通常是作为在用户程序和内核之间提供一个接口，即`系统调用`

  CPU提供了一个特殊的指令`syscall n`，`n`是用户需要请求的系统调用号，当用户执行这个指令时，控制传递给相应的内核处理程序即`陷阱处理程序`，处理完成后返回到用户代码的**下一条指令**

- `故障`：这个就是通常意义上的异常类型，当程序发生错误产生故障后，CPU将控制转移给对应的exception handler，此时有两种情况，如果故障处理器能够修正这个错误，就可以返回到**之前故障的指令**重新执行，如果处理不了，内核的abort程序就会中止这段应用

  比如调用内存缺页后，就会产生一个故障，缺页处理程序会从磁盘中加载对应的内存页到内存中，指令可以继续执行

- `终止`：这类异常时不可恢复的致命错误，这类异常发生后，对应的exception handler为终止处理程序，它**不会将控制返还给出错的应用**，而是直接返回给abort例程进行程序的终止

  计算机中一些致命的机器故障就会触发终止

x86-64架构中有256个异常号，其中0~31号是Intel设计师定义的系统异常，包括除以0，缺页或者segment fault等异常；剩下从32到255号是操作系统自己定义的中断号和陷阱号

> C程序调用某个系统函数时，在编译后的汇编指令中，一般将系统调用号存放于%rax寄存器，将过程调用参数列表存放于%rdi, %rsi, %rdx, %r10, %r8, %r9，一共6个，参数列表按照顺序存放在寄存器
>
> 调用返回值仍旧存放在%rax寄存器，如果返回值是负数，说明发生了错误