title: gossip协议初探——原理及应用
author: 天渊
tags:
  - gossip
categories: []
date: 2020-09-13 11:48:00
---
### 什么是gossip协议
`Gossip Protocol`，字面理解也就是`绯闻协议`，还有个名字叫做`Epidimic Protocol(流行性协议)`，这个协议基于`最终一致性(BASE)`以及`去中心化`的设计思想，被广泛运用于各个分布式系统中，用于分布式节点之间进行信息交换和数据同步，具有`低负载`，`高可靠`和`可扩展性`等特点，其比较著名的设计实现包括redis-cluster，Cassandra数据库，KV存储中间件Consul，以及一些区块链项目也使用了`Gossip Protocol`来实现信息交互
<!--more-->

#### Gossip协议的理论基础
`Gossip Protocol`最早是在1987年发表在ACM上的论文 《Epidemic Algorithms for Replicated Database Maintenance》中被提出，其理论基础来源于流行病学的数学模型，这种场景的一个最大特点就是组成的网络的节点都是去中心化的对等节点，在信息同步过程中不能保证某个时刻所有节点都收到消息，但是理论上最终所有节点都会收到消息，实现最终一致性协议

### Gossip协议主要概念
`Gossip Protocol`是利用一种随机的方式将信息散播到整个集群网络中，就像流言蜚语或者流行病毒的传播过程，通过`一传十，十传百`，在没有中心调度节点的情况下，短时间内自动将消息同步到集群中的每个节点：

![gossip-protocol](http://img.mantian.site/Snipaste_2020-09-13_11-49-46.png)

如图所述，集群中每个节点随机选择通讯对象并向其发送信息，以达到共识信息在整个集群进行同步的目的

#### Gossip协议的特点

`Gossip Protocol`有以下几个优势：

1. **扩展性**：集群网络允许任意个节点，新加入的节点的状态最终会与其他节点一致
2. **容错**：集群中任何节点失效都不会影响集群消息的传播
3. **去中心化**：集群中任何节点的地位都是对等的，只要网络是连通的，任意一个节点就可以把消息散播到全网
4. **一致性收敛**：系统状态的不一致可以在很快的时间内收敛到一致，消息传播速度能够达到 `logN`

相应的，Gossip协议又有以下缺点：

1. **消息延迟**：集群消息需要经过多个轮次才能让整个集群状态达到一致，因此使用 Gossip 协议会造成不可避免的消息延迟，不适合用在对实时性要求较高的场景
2. **消息冗余**：由于在某些Gossip实现中，集群节点需要定期随机选择周围节点发送消息，收到消息的节点也会重复该步骤，因此就不可避免的存在消息重复发送给同一节点的情况，造成了消息的冗余

### Gossip协议实现形式

`Gossip Protocol`实现形式大致分为两种：`Anti-Entropy`，`Rumor-Mongering`

#### Anti-Entropy

`Anti-Entropy`，即`反熵`，顾名思义，熵代表混乱，那么反熵就是在混乱中寻求一致，因此Gossip协议的反熵实现其主要目的就是想要集群状态尽快达到一致：

1. 反熵模式下，一个节点会定期把**所有的数据**都跟其他节点共享，以便消除节点之间数据的任何不一致，它可以保证最终完全的一致，这种方式集群收敛速度很快
2. 反熵模式下，消息会**不断反复的交换**，消息数量是无限制的，对系统来说是非常巨大的开销

#### Rumor-Mongering

`Rumor-Mongering`，即`谣言传播`，顾名思义只有当有**新的“谣言”产生时**才需要进行信息交互，因此在这种模式下消息只包含最新信息，消息体积更小，消息可以发送得更频繁，但相比于`Anti-Entropy`模式，由于`Rumor-Mongering`模式规定一个消息在某个时间后会被标记为过期不再传播，因此这种情况下集群状态有可能会产生不一致

### Gossip协议的信息交互

`Gossip Protocol`根据信息交互方式又可以分为`Push-based`，`Pull-based`以及`Pull-Push-based`三种实现：

#### Push-based
基于推模式的`Gossip Protocol`，其大致实现主要有以下几个步骤：
1. 网络中的某个节点随机的选择其他N个节点作为传输对象。
2. 该节点向其选中的N个节点传输相应的信息
3. 接收到信息的节点重复完成相同的工作

#### Pull-based
基于拉模式，大致实现有以下几个步骤：
1. 某个节点随机选择N个节点询问有没有最新的信息
2. 这N个节点在收到询问后向其回复是否有最新信息

#### Pull-Push-based

除了这两种模式，`Gossip Protocol`还有基于这两种模式的混合模式`Pull-Push-based`：

1. 源节点随机选择N个节点作为目标节点，询问其有没有最新的信息
2. 目标节点将本地比源节点新的数据推送给源节点，源节点则更新本地
3. 源节点再将本地比目标节点新的数据推送给目标节点，目标节点则更新本地

相比之下`Push-based`网络通信消耗最低，而`Pull-Push-based`虽然通信消耗最高，但集群交互收敛性更强，理论上一次通信就可以使两个节点的状态完全一致

![convergence time](http://img.mantian.site/Snipaste_2020-09-13_11-52-08.png	)

上图反映了三种通信模式下集群状态的收敛程度，可以看到，`Pull-Push-based`的收敛性是最强的

#### 对网络可靠性要求较低
`Gossip Protocol`原则上并不对网络的质量做出任何要求，因此很多`Gossip Protocol`都基于`UDP`协议进行实现