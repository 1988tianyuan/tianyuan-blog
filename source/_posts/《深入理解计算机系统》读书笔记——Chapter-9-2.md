title: 《深入理解计算机系统》读书笔记——Chapter 9(2)
author: 天渊
tags:
  - csapp
categories:
  - 读书笔记
date: 2019-11-22 17:50:00
---
第九章：`虚拟内存`（2）

这一部分主要学习虚拟内存地址翻译的一些知识点

<!--more-->

### 虚拟地址翻译的基本知识

虚拟地址和物理地址的信息映射主要体现在页表上，因此进行地址翻译主要就是借助页表中的PTE页表项中记录的信息（有效位，物理页地址或者磁盘地址）

n位的虚拟地址由两部分组成：

- **虚拟页号（VPN）**：表示该地址对应的虚拟页的index，用于在页表中找到对应的PTE
- **虚拟页偏移量（VPO）**：表示该地址在虚拟页中的偏移位置，VPO与具体的物理页偏移量PPO是相同的，用于在物理页中找到具体的数据位置

如下图所示：

![](http://img.mantian.site/201911221128_827.png)

在进行虚拟寻址的过程中，`页表基址寄存器（PTBR）`中存储了当前进程的页表位置，` 内存管理单元(MMU) `通过VPN找到该虚拟地址对应的页表PTE项，首先判断有效位，如果**不缺页**的话就取出存储的物理页号PPN，物理页号加上物理页偏移量PPO（也就是虚拟页号VPO）就是具体的物理内存地址，下图就是MMU取数据时的整个流程：

![](http://img.mantian.site/201911221139_752.png)

其中MMU通过步骤3拿到PTE的数据后会判断是否命中页面，如果没有的话就要触发缺页异常：

![](http://img.mantian.site/201911221327_876.png)

MMU触发缺页异常，将控制权交给缺页处理程序，缺页处理程序进行换页操作，将需要的页换回主存，控制权交回给MMU重新执行步骤3，后续就跟之前相同了

**通过L1高速缓存加速获取PTE**：上图中，MMU通过虚拟地址获取PTE的过程，既可以从物理内存中获取，也可以从SRAM高速缓存中获取，如果能够命中的话能够将整个过程的时钟周期从上百个减少到一两个

**通过TLB高速缓存加速获取PTE**：现在很多主流CPU在MMU中集成了一个特有的专门用于存放PTE信息的缓存，叫做`翻译后备缓冲器TLB（Translation Lookaside Buffer）`，能够极大的加速获取PTE信息的过程，步骤如下

1. MMU接收到虚拟地址，MMU使用虚拟地址的虚拟页号VPN从TLB中寻找具体的PTE，VPN由`TLB索引`和`TLB标记`组成
2. MMU使用PTE取出找到数据的物理地址，从高速缓存或者内存中取出数据

如果MMU在TLB中没有找到对应的PTE，则需要从高速缓存或者内存中获取PTE，存放到TLB中，再从内存中获取数据：

![](http://img.mantian.site/201911221550_41.png)



#### 多级页表

> **为什么需要多级页表?**
>
> 每一个进程启动后，系统都会给它分配一个常驻的页表，如果是32位系统，每个PTE大小位4 bytes，那