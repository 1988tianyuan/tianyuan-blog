title: 如何理解3PC协议
author: 天渊
tags:
  - 分布式理论
categories: []
date: 2019-03-28 22:33:00
---
3PC协议是在2PC协议的基础上发展而来，全称是`Three-Phase Commit`，即三阶段提交

<!--more-->

### 3PC整体流程

3PC将2PC第二阶段提交协议的"提交事务请求"一分为二，总共划分为`CanCommit`，`PreCommit`和`DoCommit`三个阶段：


![upload successful](\blog\images\3pc-1.png)

![upload successful](\blog\images\3pc-2.png)

![upload successful](\blog\images\3pc-3.png)

##### 阶段一：CanCommit

1. 事务询问：协调者向参与者发送包含事务内容的`CanCommit`请求，询问是否可以执行事务提交
2. 反馈询问响应：参与者如果认为其自身可以顺利执行事务，则反馈`Yes`响应并进入预备状态，否则反馈`No`状态

##### 阶段二：PreCommit

如果协调者从所有参与者获得的反馈都是`Yes`，则执行事务预提交：

1. 发送预提交请求：协调者向参与者发出`PreCommit`请求并进入`Prepare`阶段
2. 事务预提交：参与者收到协调者的`PreCommit`请求后，执行事务操作并记录undo和redo日志，
3. 反馈事务执行响应：参与者向协调者反馈事务的预提交结果，`Yes`或者`No`

如果阶段一有参与者反馈`No`或者与协调者通讯超时，协调者则会发起事务中断：

1. 发送`abort`请求：协调者向参与者发起`abort`请求，中断事务
2. 中断事务：参与者收到`abort`请求，执行中断事务操作
3. 阶段二中，如果参与者等待协调者的任何请求超时均会执行中断事务操作

##### 阶段三：DoCommit

如果上一阶段协调者从所有参与者那里都获得`Yes`反馈，则执行事务最终提交：

1. 发送提交请求：协调者进入`Commit`状态，向所有参与者发起`DoCommit`请求
2. 事务提交：参与者收到`DoCommit`请求，会执行事务提交操作，最后释放事务资源
3. 反馈提交结果：参与者反馈事务提交结果，协调者收到所有反馈结果后完成事务

如果阶段二有参与者反馈`No`或者通讯超时，协调者则会发起事务中断：

1. 发送`abort`请求：协调者向参与者发起`abort`请求，中断事务向
2. 事务回滚：参与者收到`abort`请求后，会利用undo log执行`RollBack`操作，并在回滚完成后释放资源
3. 反馈回滚结果：参与者反馈回滚结果，协调者收到所有回滚结果后中断整个事务
4. 阶段三中，如果参与者等待协调者的任何请求超时均会直接执行事务提交操作

#### 结论

3PC相比于2PC，最大优点降低了参与者的阻塞范围，每个参与者不需要等待全局响应完成就能够自己做出判断（中断 or 提交），并且即使在协调者出现单点故障后仍然能够尽最大可能保障数据一致

**3PC的缺点**：3PC虽然提高了效率，但并没有解决完全保障数据强一致性的问题，那就是在`PreCommit`后，如果协调者和某个参与者无法正常通信，该参与者仍然会执行提交，若另外有参与者提交失败，则会造成数据不一致

保障分布式系统数据一致性最终还得靠`Paxos`算法